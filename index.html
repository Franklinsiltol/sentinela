<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinela - An√°lise Inteligente com IA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- Transformers.js para IA -->
    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0/dist/transformers.min.js';
        window.transformersPipeline = pipeline;
    </script>
    
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #FFFFFF;
            --accent-color: #4CAF50;
            --warning-color: #FFC107;
            --danger-color: #F44336;
            --info-color: #2196F3;
            --light-gray: #f5f7fa;
            --medium-gray: #e4e7ed;
            --dark-gray: #333333;
            --sidebar-width: 300px;
            --header-height: 70px;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--light-gray);
            color: var(--primary-color);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--secondary-color);
            box-shadow: var(--box-shadow);
            padding: 20px;
            overflow-y: auto;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: var(--transition);
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--medium-gray);
        }

        .logo-icon {
            font-size: 2rem;
            margin-right: 10px;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 4px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 90px 20px 20px 20px;
            width: calc(100% - var(--sidebar-width));
        }

        /* Header */
        .header {
            height: var(--header-height);
            background-color: var(--secondary-color);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--medium-gray);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            background-color: var(--light-gray);
        }

        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* Buttons */
        .button {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .button:hover {
            background-color: var(--dark-gray);
        }

        .button-success {
            background-color: var(--accent-color);
        }

        .button-warning {
            background-color: var(--warning-color);
        }

        .button-danger {
            background-color: var(--danger-color);
        }

        .button-info {
            background-color: var(--info-color);
        }

        /* Input Groups */
        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            background-color: var(--secondary-color);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Alerts */
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background-color: #e8f5e9;
            border-left: 4px solid var(--accent-color);
        }

        .alert-warning {
            background-color: #fff3cd;
            border-left: 4px solid var(--warning-color);
        }

        .alert-error {
            background-color: #ffebee;
            border-left: 4px solid var(--danger-color);
        }

        .alert-info {
            background-color: #e3f2fd;
            border-left: 4px solid var(--info-color);
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid var(--medium-gray);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--medium-gray);
        }

        .data-table th {
            background-color: var(--light-gray);
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: var(--light-gray);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--accent-color);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Audio Items */
        .audio-item {
            background: var(--light-gray);
            padding: 15px;
            margin: 10px 0;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--info-color);
        }

        .audio-item.processing {
            border-left-color: var(--warning-color);
        }

        .audio-item.completed {
            border-left-color: var(--accent-color);
        }

        .audio-item.error {
            border-left-color: var(--danger-color);
        }

        .audio-filename {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .audio-metadata {
            font-size: 0.9rem;
            color: var(--dark-gray);
            margin-bottom: 8px;
        }

        .audio-transcription {
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 8px;
            font-style: italic;
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.processing {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-badge.completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-badge.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Hidden Class */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <span class="logo-icon">ü§ñ</span>
                <span class="logo-text">Sentinela IA</span>
            </div>

            <div class="section">
                <div class="section-title">
                    <i class="fas fa-google-drive"></i>
                    <span>Google Drive</span>
                </div>
                <div class="input-group">
                    <label>ID da Pasta (√Åudios)</label>
                    <input type="text" id="driveFolderId" placeholder="ID da pasta do Google Drive">
                </div>
                <div class="input-group">
                    <label>ID da Pasta (Base de Conhecimento)</label>
                    <input type="text" id="knowledgeFolderId" placeholder="Opcional">
                </div>
                <button class="button button-info" id="connectDriveBtn">
                    <i class="fas fa-plug"></i> Conectar Drive
                </button>
            </div>

            <div class="section">
                <div class="section-title">
                    <i class="fas fa-brain"></i>
                    <span>Configura√ß√£o IA</span>
                </div>
                <div class="input-group">
                    <label>Prompt de An√°lise</label>
                    <textarea id="analysisPrompt" placeholder="Ex: Analise o sentimento e identifique problemas mencionados pelo cliente...">Analise a transcri√ß√£o e identifique:
1. Sentimento geral (positivo/negativo/neutro)
2. Principais problemas mencionados
3. Solicita√ß√µes do cliente
4. N√≠vel de satisfa√ß√£o (1-5)</textarea>
                </div>
                <div class="input-group">
                    <label>Modelo Whisper</label>
                    <select id="whisperModel">
                        <option value="tiny">Tiny (r√°pido)</option>
                        <option value="base" selected>Base (balanceado)</option>
                        <option value="small">Small (preciso)</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    <i class="fas fa-table"></i>
                    <span>Google Sheets</span>
                </div>
                <div class="input-group">
                    <label>ID da Planilha</label>
                    <input type="text" id="sheetsId" placeholder="ID do Google Sheets">
                </div>
                <div class="input-group">
                    <label>Nome da Aba</label>
                    <input type="text" id="sheetsTabName" value="Transcri√ß√µes" placeholder="Nome da aba">
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    <i class="fas fa-chart-bar"></i>
                    <span>Estat√≠sticas</span>
                </div>
                <div style="font-size: 0.9rem;">
                    <p><strong>√Åudios:</strong> <span id="statsTotal">0</span></p>
                    <p><strong>Processados:</strong> <span id="statsProcessed">0</span></p>
                    <p><strong>Erros:</strong> <span id="statsErrors">0</span></p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 class="header-title">üéØ Sentinela IA - An√°lise de √Åudios</h1>
            </header>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" data-tab="processamento">
                    <i class="fas fa-cog"></i> Processamento
                </div>
                <div class="tab" data-tab="resultados">
                    <i class="fas fa-list"></i> Resultados
                </div>
                <div class="tab" data-tab="exportacao">
                    <i class="fas fa-download"></i> Exporta√ß√£o
                </div>
            </div>

            <!-- Tab: Processamento -->
            <div class="tab-content active" id="tab-processamento">
                <div class="card">
                    <div class="card-title">üéµ Controle de Processamento</div>
                    
                    <div id="alertContainer"></div>

                    <div style="margin-bottom: 20px;">
                        <button class="button button-success" id="startProcessingBtn">
                            <i class="fas fa-play"></i> Iniciar Processamento
                        </button>
                        <button class="button button-warning hidden" id="pauseProcessingBtn">
                            <i class="fas fa-pause"></i> Pausar
                        </button>
                        <button class="button button-danger" id="clearDataBtn">
                            <i class="fas fa-trash"></i> Limpar Tudo
                        </button>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                    </div>

                    <div id="processingStatus" class="loading hidden">
                        <div class="spinner"></div>
                        <p style="margin-top: 10px;">Carregando modelo Whisper...</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üìÇ √Åudios Detectados</div>
                    <div id="audioList"></div>
                </div>
            </div>

            <!-- Tab: Resultados -->
            <div class="tab-content" id="tab-resultados">
                <div class="card">
                    <div class="card-title">üìä Resultados da An√°lise</div>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="searchResults" placeholder="Buscar por telefone, CID, e-mail..." 
                               style="width: 100%; padding: 10px; border: 1px solid var(--medium-gray); border-radius: var(--border-radius);">
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Telefone</th>
                                    <th>CID</th>
                                    <th>E-mail</th>
                                    <th>Transcri√ß√£o</th>
                                    <th>An√°lise IA</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px;">
                                        Nenhum resultado ainda. Processe os √°udios primeiro.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab: Exporta√ß√£o -->
            <div class="tab-content" id="tab-exportacao">
                <div class="grid-2">
                    <div class="card">
                        <div class="card-title">üíæ Exportar CSV</div>
                        <p>Baixe todos os resultados em formato CSV para an√°lise externa.</p>
                        <button class="button button-info" id="exportCsvBtn" style="margin-top: 15px;">
                            <i class="fas fa-file-csv"></i> Baixar CSV
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-title">üìä Exportar Excel</div>
                        <p>Baixe todos os resultados em formato Excel com formata√ß√£o.</p>
                        <button class="button button-success" id="exportExcelBtn" style="margin-top: 15px;">
                            <i class="fas fa-file-excel"></i> Baixar Excel
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-title">üìà Enviar para Google Sheets</div>
                        <p>Alimenta automaticamente a planilha configurada na sidebar.</p>
                        <button class="button button-primary" id="sendToSheetsBtn" style="margin-top: 15px;">
                            <i class="fas fa-upload"></i> Enviar para Sheets
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-title">üìÑ Exportar JSON</div>
                        <p>Baixe os dados completos em formato JSON.</p>
                        <button class="button button-warning" id="exportJsonBtn" style="margin-top: 15px;">
                            <i class="fas fa-code"></i> Baixar JSON
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // ============================================
        // SISTEMA SENTINELA IA
        // ============================================
        
        let processedData = [];
        let whisperPipeline = null;
        let analysisPipeline = null;
        let isProcessing = false;
        let isPaused = false;

        // Elementos DOM
        const DOM = {
            driveFolderId: document.getElementById('driveFolderId'),
            knowledgeFolderId: document.getElementById('knowledgeFolderId'),
            connectDriveBtn: document.getElementById('connectDriveBtn'),
            analysisPrompt: document.getElementById('analysisPrompt'),
            whisperModel: document.getElementById('whisperModel'),
            sheetsId: document.getElementById('sheetsId'),
            sheetsTabName: document.getElementById('sheetsTabName'),
            startProcessingBtn: document.getElementById('startProcessingBtn'),
            pauseProcessingBtn: document.getElementById('pauseProcessingBtn'),
            clearDataBtn: document.getElementById('clearDataBtn'),
            progressBar: document.getElementById('progressBar'),
            processingStatus: document.getElementById('processingStatus'),
            audioList: document.getElementById('audioList'),
            resultsTableBody: document.getElementById('resultsTableBody'),
            searchResults: document.getElementById('searchResults'),
            alertContainer: document.getElementById('alertContainer'),
            statsTotal: document.getElementById('statsTotal'),
            statsProcessed: document.getElementById('statsProcessed'),
            statsErrors: document.getElementById('statsErrors'),
            exportCsvBtn: document.getElementById('exportCsvBtn'),
            exportExcelBtn: document.getElementById('exportExcelBtn'),
            sendToSheetsBtn: document.getElementById('sendToSheetsBtn'),
            exportJsonBtn: document.getElementById('exportJsonBtn')
        };

        // Event Listeners
        DOM.connectDriveBtn.addEventListener('click', connectToDrive);
        DOM.startProcessingBtn.addEventListener('click', startProcessing);
        DOM.pauseProcessingBtn.addEventListener('click', pauseProcessing);
        DOM.clearDataBtn.addEventListener('click', clearData);
        DOM.searchResults.addEventListener('input', filterResults);
        DOM.exportCsvBtn.addEventListener('click', exportToCsv);
        DOM.exportExcelBtn.addEventListener('click', exportToExcel);
        DOM.sendToSheetsBtn.addEventListener('click', sendToGoogleSheets);
        DOM.exportJsonBtn.addEventListener('click', exportToJson);

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // Fun√ß√µes
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            DOM.alertContainer.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        function parseFilename(filename) {
            // Padr√£o: +5585987847084CID2029111bymaysa.santos@sumup.com@2_23_46 PM.wav
            const phoneMatch = filename.match(/\+?(\d{10,15})/);
            const cidMatch = filename.match(/CID(\d+)/);
            const emailMatch = filename.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
            
            return {
                telefone: phoneMatch ? phoneMatch[1] : 'N/A',
                cid: cidMatch ? cidMatch[1] : 'N/A',
                email: emailMatch ? emailMatch[1] : 'N/A'
            };
        }

        async function connectToDrive() {
            const folderId = DOM.driveFolderId.value.trim();
            if (!folderId) {
                showAlert('Por favor, insira o ID da pasta do Google Drive', 'error');
                return;
            }

            showAlert('‚ö†Ô∏è DEMO MODE: Em produ√ß√£o, voc√™ precisaria autenticar com Google Drive API', 'warning');
            showAlert('üìù Para este demo, vou simular alguns arquivos WAV', 'info');
            
            // Simular arquivos para demonstra√ß√£o
            const simulatedFiles = [
                '+5585987847084CID2029111bymaysa.santos@sumup.com@2_23_46 PM.wav',
                '+5511999887766CID2029112byjoao.silva@sumup.com@3_15_22 PM.wav',
                '+5521988776655CID2029113bymaria.costa@sumup.com@10_45_18 AM.wav'
            ];

            displayAudioFiles(simulatedFiles);
        }

        function displayAudioFiles(files) {
            DOM.audioList.innerHTML = '';
            files.forEach((filename, index) => {
                const metadata = parseFilename(filename);
                const audioDiv = document.createElement('div');
                audioDiv.className = 'audio-item';
                audioDiv.id = `audio-${index}`;
                audioDiv.innerHTML = `
                    <div class="audio-filename">üéµ ${filename}</div>
                    <div class="audio-metadata">
                        üìû <strong>Telefone:</strong> ${metadata.telefone} | 
                        üÜî <strong>CID:</strong> ${metadata.cid} | 
                        ‚úâÔ∏è <strong>E-mail:</strong> ${metadata.email}
                    </div>
                    <div class="status-badge">Aguardando</div>
                `;
                DOM.audioList.appendChild(audioDiv);
            });
            
            DOM.statsTotal.textContent = files.length;
            showAlert(`‚úÖ ${files.length} arquivos detectados!`, 'success');
        }

        async function startProcessing() {
            const audioItems = document.querySelectorAll('.audio-item');
            if (audioItems.length === 0) {
                showAlert('Conecte-se ao Google Drive primeiro!', 'error');
                return;
            }

            isProcessing = true;
            DOM.startProcessingBtn.classList.add('hidden');
            DOM.pauseProcessingBtn.classList.remove('hidden');
            DOM.processingStatus.classList.remove('hidden');

            showAlert('ü§ñ Carregando modelo Whisper Web...', 'info');

            try {
                // Carregar Whisper (simulado para demo)
                await new Promise(resolve => setTimeout(resolve, 2000));
                showAlert('‚úÖ Modelo Whisper carregado!', 'success');
                DOM.processingStatus.classList.add('hidden');

                // Processar cada √°udio
                for (let i = 0; i < audioItems.length; i++) {
                    if (isPaused) {
                        showAlert('‚è∏Ô∏è Processamento pausado', 'warning');
                        break;
                    }

                    const audioDiv = audioItems[i];
                    const filename = audioDiv.querySelector('.audio-filename').textContent.replace('üéµ ', '');
                    
                    await processAudio(filename, audioDiv, i, audioItems.length);
                }

                if (!isPaused) {
                    showAlert('üéâ Processamento conclu√≠do!', 'success');
                    DOM.startProcessingBtn.classList.remove('hidden');
                    DOM.pauseProcessingBtn.classList.add('hidden');
                }
            } catch (error) {
                showAlert(`‚ùå Erro: ${error.message}`, 'error');
                DOM.startProcessingBtn.classList.remove('hidden');
                DOM.pauseProcessingBtn.classList.add('hidden');
            }
        }

        async function processAudio(filename, audioDiv, index, total) {
            // Atualizar status
            audioDiv.classList.add('processing');
            const statusBadge = audioDiv.querySelector('.status-badge');
            statusBadge.textContent = 'Transcrevendo...';
            statusBadge.className = 'status-badge processing';

            // Simular transcri√ß√£o (em produ√ß√£o, usar Whisper Web aqui)
            await new Promise(resolve => setTimeout(resolve, 2000));
            const transcription = `[DEMO] Transcri√ß√£o simulada do arquivo ${filename}. Ol√°, gostaria de resolver um problema com meu cart√£o. N√£o est√° funcionando h√° 2 dias.`;

            // Atualizar status
            statusBadge.textContent = 'Analisando com IA...';

            // Simular an√°lise com IA
            await new Promise(resolve => setTimeout(resolve, 1500));
            const analysis = {
                sentimento: 'Negativo',
                problemas: ['Cart√£o n√£o funcionando', 'Problema h√° 2 dias'],
                satisfacao: 2
            };

            // Atualizar status
            statusBadge.textContent = 'Conclu√≠do';
            statusBadge.className = 'status-badge completed';
            audioDiv.classList.remove('processing');
            audioDiv.classList.add('completed');

            // Adicionar transcri√ß√£o ao card
            const transcriptionDiv = document.createElement('div');
            transcriptionDiv.className = 'audio-transcription';
            transcriptionDiv.textContent = transcription;
            audioDiv.appendChild(transcriptionDiv);

            // Salvar dados
            const metadata = parseFilename(filename);
            processedData.push({
                ...metadata,
                transcricao: transcription,
                analise: JSON.stringify(analysis, null, 2),
                status: 'Conclu√≠do'
            });

            // Atualizar estat√≠sticas
            DOM.statsProcessed.textContent = processedData.length;
            
            // Atualizar barra de progresso
            const progress = Math.round(((index + 1) / total) * 100);
            DOM.progressBar.style.width = `${progress}%`;
            DOM.progressBar.textContent = `${progress}%`;

            // Atualizar tabela de resultados
            updateResultsTable();
        }

        function pauseProcessing() {
            isPaused = true;
            isProcessing = false;
            DOM.startProcessingBtn.classList.remove('hidden');
            DOM.pauseProcessingBtn.classList.add('hidden');
        }

        function clearData() {
            if (confirm('Tem certeza que deseja limpar todos os dados?')) {
                processedData = [];
                DOM.audioList.innerHTML = '';
                DOM.resultsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">Nenhum resultado ainda.</td></tr>';
                DOM.progressBar.style.width = '0%';
                DOM.progressBar.textContent = '0%';
                DOM.statsTotal.textContent = '0';
                DOM.statsProcessed.textContent = '0';
                DOM.statsErrors.textContent = '0';
                showAlert('üóëÔ∏è Dados limpos!', 'info');
            }
        }

        function updateResultsTable() {
            if (processedData.length === 0) {
                DOM.resultsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">Nenhum resultado ainda.</td></tr>';
                return;
            }

            DOM.resultsTableBody.innerHTML = processedData.map(data => `
                <tr>
                    <td>${data.telefone}</td>
                    <td>${data.cid}</td>
                    <td>${data.email}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${data.transcricao}</td>
                    <td><pre style="font-size: 0.8rem; max-width: 200px; overflow: auto;">${data.analise}</pre></td>
                    <td><span class="status-badge completed">${data.status}</span></td>
                </tr>
            `).join('');
        }

        function filterResults() {
            const searchTerm = DOM.searchResults.value.toLowerCase();
            const rows = DOM.resultsTableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function exportToCsv() {
            if (processedData.length === 0) {
                showAlert('Nenhum dado para exportar!', 'error');
                return;
            }

            const headers = ['Telefone', 'CID', 'E-mail', 'Transcri√ß√£o', 'An√°lise', 'Status'];
            const csvContent = [
                headers.join(','),
                ...processedData.map(row => 
                    [row.telefone, row.cid, row.email, `"${row.transcricao}"`, `"${row.analise}"`, row.status].join(',')
                )
            ].join('\n');

            downloadFile(csvContent, 'sentinela_ia_export.csv', 'text/csv');
            showAlert('‚úÖ CSV exportado com sucesso!', 'success');
        }

        function exportToJson() {
            if (processedData.length === 0) {
                showAlert('Nenhum dado para exportar!', 'error');
                return;
            }

            const jsonContent = JSON.stringify(processedData, null, 2);
            downloadFile(jsonContent, 'sentinela_ia_export.json', 'application/json');
            showAlert('‚úÖ JSON exportado com sucesso!', 'success');
        }

        function exportToExcel() {
            showAlert('üìä Para exportar Excel, voc√™ precisaria usar uma biblioteca como SheetJS/xlsx', 'info');
            showAlert('üí° Por ora, use a exporta√ß√£o CSV que pode ser aberta no Excel', 'warning');
        }

        function sendToGoogleSheets() {
            const sheetsId = DOM.sheetsId.value.trim();
            if (!sheetsId) {
                showAlert('Configure o ID do Google Sheets na sidebar!', 'error');
                return;
            }

            if (processedData.length === 0) {
                showAlert('Nenhum dado para enviar!', 'error');
                return;
            }

            showAlert('‚ö†Ô∏è DEMO MODE: Em produ√ß√£o, voc√™ usaria a Google Sheets API para enviar os dados', 'warning');
            showAlert(`‚úÖ Simulando envio de ${processedData.length} registros para a planilha...`, 'success');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Inicializa√ß√£o
        showAlert('üöÄ Sentinela IA carregado! Conecte-se ao Google Drive para come√ßar.', 'info');
    </script>
</body>
</html>
